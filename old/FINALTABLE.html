<!DOCTYPE html>
<html lang="en">
<meta charset="utf-8">
<body>
<form>
<span>
Time Update: <span id = 'min_year'> </span>
<input type="range" name="points" step="1" id="slider-time" oninput="change_year(this.value)"> <span id='max_year'> </span>
</span>
<div>
<span>
Filter by:
<label>Americas<input type="checkbox" name="Americas" value="Americas" title="Americas" onchange = "update_continents()"></input></label>
<label>Africa<input type="checkbox" name="Africa" value="Africa" title="Africa" onchange = "update_continents()"></input></label>
<label>Europe<input type="checkbox" name="Europe" value="Europe" title="Europe" onchange = "update_continents()"></input></label>
<label>Oceania<input type="checkbox" name="Oceania" value="Oceania" title="Oceania" onchange = "update_continents()"></input></label>
<label>Asia<input type="checkbox" name="Asia" value="Asia" title="Asia" onchange = "update_continents()"></input></label>
</span>
<div>
Aggregation:
<span>
<label>None<input type="radio" name="aggregation" value="None" onchange="update_table()"></label>
<label>by Continent<input type="radio" name="aggregation" value="by Continent" onchange="update_aggregation()"></label>
</span>
</form>
<script src="http://d3js.org/d3.v3.min.js"></script>
<link rel="stylesheet" type="text/css" href="style.css" />
<script>
var info = [];
var table;
var columns;
var tbody;
var current = 1995;
var min_year;
var max_year;
var original_data;
var year_data = [];
var aggregated_data = [];
var new_table = true;
var aggregated = false;
d3.json("data/countries_1995_2012.json", function(error, data) {
original_data = data;
update_table()
var yeararray = d3.selectAll(original_data[0].years)
var allYears = [];
for (i = 0, length = yeararray[0].length; i < length; i++) {
allYears.push(yeararray[0][i].year)
}
min_year = d3.min(allYears)
d3.select("#min_year").append("span").html(min_year)
d3.select("#slider-time").attr("min", min_year)
d3.select("#slider-time").attr("value", min_year)
max_year = d3.max(allYears)
d3.select("#max_year").append("span").html(max_year)
d3.select("#slider-time").attr("max", max_year)
})
function update_table() {
aggregated = false;
if (new_table == false) {
table.remove()
}
var year_data = [];
filter_year()
columns = ["name", "continent", "gdp", "life_expectancy", "population", "year"];
create_table(info, columns)
new_table = false
};
function create_table(data, columns) {
table = d3.select("body").append("table");
thead = table.append("thead")
.attr("class", "thead");
tbody = table.append("tbody");
table.append("caption")
.html("World Countries Ranking");
thead.append("tr").selectAll("th")
.data(columns)
.enter()
.append("th")
.text(function(d) {
return d;
})
.attr("class", "sort")
.on("click", function(header, i) {
tbody.selectAll("tr").sort(function(a, b) {
if (a[header] == b[header])
{
var sorted = d3.ascending(a["name"], b["name"]);
return d3.ascending(a["name"], b["name"]);
}
if (header == "name" || header == "continent") {
if (table.attr("class") == "sort") {
return d3.descending(a[header], b[header]);
} else {
return d3.ascending(a[header], b[header]);
}
} else {
if (table.attr("class") == "sort") {
if (a[header] < b[header]) {
return -1;
}
if (a[header] > b[header]) {
return 1;
}
return 0;
} else {
if (a[header] > b[header]) {
return -1;
}
if (a[header] < b[header]) {
return 1;
}
return 0;
}
}
});
if (table.attr("class") == "sort") {
table.attr("class", null)
//
} else {
table.attr("class", "sort")
}
zebra_striping(tbody);
})
var rows = tbody.selectAll("tr.row")
.data(data)
.enter()
.append("tr")
.attr("class", "row")
.on("mouseover", function(d, i) {
d3.select(this)
.style("background-color", "green")
})
.on("mouseout", function(d, i) {
d3.select(this)
.style("background-color", "transparent")
zebra_striping(tbody)
})
zebra_striping(tbody)
var cells = rows.selectAll("td")
.data(function(row) {
var display_row = []
for (var key in row) {
if (columns.indexOf(key) < 0) {
delete row[key];
} else {
display_row.splice(columns.indexOf(key), 0, row[key])
}
}
return display_row;
})
.enter()
.append("td")
.text(function(input, i) {
if (i == 3) {
var rounded = d3.round(+input, 1);
return rounded;
}
var pop_formatted = d3.format("0,000");
if (i == 4) {
return pop_formatted(input);
}
if (i == 2) {
var GDP_formatted = d3.formatPrefix(input);
return d3.round(GDP_formatted.scale(input), 1) + GDP_formatted.symbol;
}
return input;
});
update_continents()
}
function update_aggregation() {
filter_year()
var nested_rows = d3.nest()
.key(function(d) {
return d.continent;
})
.rollup(function(leaves) {
return {
"name": leaves.continent,
"continent": leaves.continent,
// //"years": [{}]
"population": d3.sum(leaves, function(d) {
return d.population;
}),
"life_expectancy": d3.mean(leaves, function(d) {
return d.life_expectancy;
}),
"gdp": d3.sum(leaves, function(d) {
return d.gdp;
}),
"year": current
};
})
.entries(info);
d3.selectAll("nested_rows")
for (var i = 0, length = nested_rows.length; i < length; i++) {
aggregated_data.push({});
aggregated_data[i].continent = nested_rows[i].key
aggregated_data[i].name = nested_rows[i].key
aggregated_data[i].gdp = nested_rows[i].values.gdp
aggregated_data[i].life_expectancy = nested_rows[i].values.life_expectancy
aggregated_data[i].population = nested_rows[i].values.population
aggregated_data[i].year = nested_rows[i].values.year
}
table.remove()
aggregated = true;
create_table(aggregated_data, columns)
}
function filter_year() {
year_data = []
for (var j = 0, length = original_data.length; j < length; j++) {
tempArray = {}
var index = current - 1995;
tempArray.continent = original_data[j].continent
tempArray.name = original_data[j].name
if (original_data[j].years[index]) {
tempArray.gdp = original_data[j].years[index].gdp
tempArray.life_expectancy = original_data[j].years[index].life_expectancy
tempArray.population = original_data[j].years[index].population
tempArray.year = current
year_data.push(tempArray)
}
}
info = year_data;
return info;
}
function change_year(value) {
current = value;
if (aggregated == false) {
update_table();
} else {
update_aggregation()
}
return current;
}
function update_continents() {
var checked = [];
d3.selectAll("input").each(function(d) {
if (d3.select(this).attr("type") == "checkbox" && d3.select(this).node().checked) {
checked.push(d3.select(this).attr("name"))
}
})
if (checked === undefined || checked.length == 0) {
d3.selectAll(".row")[0].forEach(function(display) {
display.className = "row";
})
} else {
d3.selectAll(".row")[0].forEach(function(continentmatch) {
if(!continentmatch.childNodes[1]) return
if (checked.indexOf(continentmatch.childNodes[1].innerText) > -1) {
continentmatch.className = "row"
} else {
continentmatch.className = "row hidden"
}
})
}
zebra_striping(tbody);
}
function zebra_striping(tbody) {
var sel = tbody.selectAll("tr.row:not(.hidden)");
sel.each(function(input, i) {
if (i % 2) {
d3.select(this).style("background-color", "#ccc")
} else {
d3.select(this).style("background-color", "white")
}
})
}
</script>
</body>
</html>